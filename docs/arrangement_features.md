# Arrangement Features

This document outlines several rhythm and arrangement options available in the project.

## `mirror_melody` for Bass Parts

The bass generator can optionally mirror the main melody line. When `mirror_melody: true` is set in the bass part parameters, the bass line is generated by inverting the melody around the tonic pitch. This creates a contrapuntal effect where the bass moves opposite to the melody.

Typical usage in a part configuration:

```yaml
bass_part:
  pattern_key: walking_8ths
  mirror_melody: true
```

If disabled or omitted, the bass follows its normal pattern selection based on emotion buckets and intensity.

You can enable this behaviour for all sections by adding `mirror_melody: true`
under `part_defaults.bass` in your `main_cfg.yml`:

```yaml
part_defaults:
  bass:
    mirror_melody: true
```

## `guitar_emotion_arpeggio` Rhythm Key

The rhythm library includes a pattern named `guitar_emotion_arpeggio`. It selects arpeggio note ordering depending on the current emotion bucket. Each bucket (e.g., `calm`, `groovy`, `energetic`) maps to a different set of arpeggio indices, giving subtly different movement for gentle versus intense passages.

The guitar generator resolves the rhythm key using the emotion bucket determined from the section's `musical_intent`. For example, a `calm` bucket might produce a slow ascending arpeggio, while an `energetic` bucket chooses a wider, faster pattern.

The mapping is defined in the YAML rhythm library. When a section specifies `rhythm_key: guitar_emotion_arpeggio`, the generator looks up the appropriate arpeggio indices according to its bucket and intensity before rendering the notes.

## Velocity Curves

Patterns may define a `velocity_curve` list under their `options`. Each event can specify a `velocity_layer` index which selects the corresponding scale factor.

```yaml
drum_patterns:
  build_intro:
    options:
      velocity_curve: [0.6, 0.8, 1.0]
    pattern:
      - {instrument: kick, offset: 0.0, velocity_layer: 0}
      - {instrument: snare, offset: 1.0, velocity_layer: 1}
      - {instrument: kick, offset: 2.0, velocity_layer: 2}
```

In this example, layer 0 uses a 0.6 multiplier, layer 1 uses 0.8 and layer 2 uses 1.0 when calculating final note velocity.

When calling the internal ``_apply_pattern()`` helper, note that the arguments
after ``drum_block_params`` are ``velocity_scale`` followed by
``velocity_curve``. Passing them in the wrong order will produce unexpected
velocity values. Using keyword arguments is recommended for clarity.

## Consonant Sync Modes

Drum events can be nudged toward detected consonants from your vocal track. The
behaviour is controlled by `global_settings.consonant_sync_mode`.

- **`bar`** – shift an entire bar toward the nearest consonant cluster.
- **`note`** – align each kick and snare hit individually.

Additional parameters under `consonant_sync` tune note mode:

- `note_radius_ms` – search window for nearby peaks (default `30.0`).
- `velocity_boost` – MIDI velocity increase applied when a hit is aligned. When
  calling `align_to_consonant` directly, use `return_vel=True` to also receive
  this increment.

The default is `bar` as illustrated in `config/main_cfg.yml`:

```yaml
global_settings:
  use_consonant_sync: true
  consonant_sync_mode: bar  # 'bar' or 'note'
```

Override the setting from the command line with `--consonant-sync-mode` when
running `modular_composer.py`.

## Guitar Expression Parameters

The guitar generator supports several parameters for expressive playing:

- `stroke_direction`: set to `"down"` or `"up"` to bias velocity 10% higher or
  lower respectively.
- `palm_mute`: when `true` notes shorten by 15% and velocity drops 15%.
- `slide_in_offset` / `slide_out_offset`: fractional offsets from 0.0‑1.0
  indicating where portamento begins and ends.
- `bend_amount`: depth of a fret bend in semitones.
- `bend_release_offset`: point before the note end when a bend releases.
